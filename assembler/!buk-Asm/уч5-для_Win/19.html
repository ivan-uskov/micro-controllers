<html>
<head>
<title>Коды Растровых Операций</title>
</head>
<BODY background="../../bgrwhite.gif">
<p><div align="center"><b><font size="+1" face="Arial">Коды растровых операций </font></b></div></p>

<p>
Выше уже было сказано, что одиннадцатый аргумент функции StretchBlt() - это код растровой
операции. Другими словами, это код, который определяет, как при операции будут взаимодействовать
биты, определяющие заливку и изображение совместимого контекста с изображением на
действительном контексте. Комбинируются биты на основе логических операций над ними. По
укоренившейся в книге по программированию для Windows традиции, эти операции записываются в
обратной польской нотации (не путать с венгерской, автор польской нотации не имеет к Microsoft
ни малейшего отношения).
<p>
По той же традиции, биты, определяющие bitmap совместимого контекста, обозначают буквой S (source
- источник, исходный), биты заливки - буквой P (pattern - образец), а биты, на которых будет
прорисовываться изображение - буквой D (destination - назначение, место назначения). Операции
обозначаются следующим образом: a - побитовое И (AND), n - побитовое НЕТ (NO), o - побитовое ИЛИ
(OR), x - побитовое исключающее ИЛИ (XOR).
<p>
Несколько слов о польской нотации. В ней операции записываются слева направо. Знак операции
следует за операндами. Появление знака операции означает, что нужно произвести следующие
действия:<br>
&nbsp;-&nbsp;взять два последних операнда
&nbsp;-&nbsp;произвести с ними требующуюся операцию
&nbsp;-&nbsp;записать результат на место последних двух операндов.
<p>
Фактически польская нотация описывает действия таким образом, словно операнды и операции
находятся в стеке, для чего, собственно, эта польская нотация и была изобретена.
<p>
Обозначив знак операции как Op, в польской нотации действия с битами можно записать таким
образом:
<p>&nbsp;&nbsp;PSOp<p>
Это говорит о необходимости взять пиксель патерны и прорисоваемого bitmap'а и произвести над
ним операцию. Если в операции участвуют три операнда, то получим:
<p>&nbsp;&nbsp;DPSOp1Op2<p>
Что мы должны сделать в этом случае? Правильно, сначала произвести действие, определяемое Op1,
с битами патерны и прорисовываемым bitmap'ом, после этого произвести Op2 с полученным результатом
и битами действительного контекста. Ничего сложного здесь нет.
<p>
Каждый код растровой операции представляется 32-битным целым. Старшее слово кода представляет
собой индекс битовой операции, младшее - код операции. Как определяется индекс операции?
<p>
Давайте представим, что нам необходимо определить индекс растровой операции, определяемой в
польской нотации записью DPSxx. Попутно можно определить и индекс операции PSx. Запишем друг под
другом ОПРЕДЕЛЕННЫЕ значения P,S и D, а под ними - результаты побитовых операций PSx и DPSxx:
<p>
<table width=90% border=0>
<tr><td width=20%>P</td><td>1</td><td>1</td><td>1</td><td>1</td><td>0</td><td>0</td><td>0</td><td>0</td></tr>
<tr><td width=20%>S</td><td>1</td><td>1</td><td>0</td><td>0</td><td>1</td><td>1</td><td>0</td><td>0</td></tr>
<tr><td width=20%>D</td><td>1</td><td>0</td><td>1</td><td>0</td><td>1</td><td>0</td><td>1</td><td>0</td>
</tr></table>
<hr>
<table width=90% border=0>
<tr><td width=20%>PSx</td><td>0</td><td>0</td><td>1</td><td>1</td><td>1</td><td>1</td><td>0</td><td>0</td></tr>
<tr><td width=20%>DPSxx</td><td>0</td><td>0</td><td>0</td><td>1</td><td>0</td><td>1</td><td>1</td><td>0</td>
</tr></table>
<p>
Итак, индекс операции PSx - 0x3C, а индекс операции DPSxx - 0x96.<br>
Уважаемый читатель, я прошу обратить внимание на то, что друг под другом записываются не
произвольные, а строго определенные значения. Эти значения позволяют перебрать все возможные
комбинации патерны, исходного и целевого bitmap'ов. Теперь, когда все стало ясно, вы можете
попробовать попрактиковаться в определении индексов дюбых операций. Несмотря на то, что
существуют 256 индексов растровых операций, на практике используются только некоторые из них. В
файле wingdi.h для наиболее часто используемых растровых операций определены идентификаторы,
которые приведены в таблице:

<center>
<h3>Краткое описание кодов растровых операций</h3>
<table width=90% border=1><tr>
<td align=center width=25% bgcolor=#000050><b>Наименование</b></td>
<td align=center width=15% bgcolor=#000050><b>Индекс<br>операции</b></td>
<td align=center width=15% bgcolor=#000050><b>Польская<br>запись</b></td>
<td align=center width=35% bgcolor=#000050><b>Эффект</b></td>
</tr><tr>
<td>BLACKNESS</td>
<td align=center>0x00</td>
<td align=center>0</td>
<td>Заполнение действительного контекста черным цветом</td>
</tr><tr>

<td>NOTSRCERASE</td>
<td align=center>0x11</td>
<td align=center>DSon</td>
<td>&nbsp;</td>
</tr><tr>

<td>NOTSRCCOPY</td>
<td align=center>0x33</td>
<td align=center>Sn</td>
<td>Прорисовываемый bitmap отображается в негативном виде</td>
</tr><tr>

<td>DSTINVERT</td>
<td align=center>0x55</td>
<td align=center>Dn</td>
<td>Изображение действительного контекста проявляется негативным</td>
</tr><tr>

<td>PATINVERT</td>
<td align=center>0x5A</td>
<td align=center>DPx</td>
<td>&nbsp;</td>
</tr><tr>

<td>SRCINVERT</td>
<td align=center>0x66</td>
<td align=center>DSx</td>
<td>&nbsp;</td>
</tr><tr>

<td>SRCAND</td>
<td align=center>0x88</td>
<td align=center>DSa</td>
<td>&nbsp;</td>
</tr><tr>

<td>MERGEPAINT</td>
<td align=center>0xBB</td>
<td align=center>DSno</td>
<td>&nbsp;</td>
</tr><tr>

<td>MERGECOPY</td>
<td align=center>0xC0</td>
<td align=center>PSa</td>
<td>&nbsp;</td>
</tr><tr>

<td>SRCCOPY</td>
<td align=center>0xCC</td>
<td align=center>S</td>
<td>Копирование прорисовываемого bitmap'а на действительный контекст</td>
</tr><tr>

<td>SCRPAINT</td>
<td align=center>0xEE</td>
<td align=center>DSo</td>
<td>&nbsp;</td>
</tr><tr>

<td>PATCOPY</td>
<td align=center>0xF0</td>
<td align=center>P</td>
<td>Копирование патерны на действительный контекст</td>
</tr><tr>

<td>PATPAINT</td>
<td align=center>0xFB</td>
<td align=center>DPSnoo</td>
<td>&nbsp;</td>
</tr><tr>

<td>WHITENESS</td>
<td align=center>0xFF</td>
<td align=center>1</td>
<td>Заполнение действительного контекста белым цветом</td>
</tr></table></center>
<p>
На основании данных таблицы я затрудняюсь объяснить, как изменяется изображение при использовании
разных растровых операций. Рекомендую читателю запустить приведенную выше программу несколько
раз, и каждый раз в функции StretchBlt() указывать новую растровую операцию.
<p>
Теперь и одиннадцатый аргумент PatBlt() стал ясным и понятным - я просто копирую bitmap в окно.
Только и всего. Кстати, понимание логики работы с растровыми операциями может позволить избежать
трудоемких преобразований bitmap'ов перед копированием.

<p><div align="center"><a href="2.html">	<img src="../../back.gif" width=66 height=29 border=0 alt=""></a></div></p>
</body>
</html>